{% extends 'geonode-mapstore-client/_geonode_config.html' %}
{% block override_local_config %}
<script>
    // https://geonode.org/geonode-mapstore-client/master/tutorial-03-override-local-config.html
    (function() {

        // Overriding or patching a component's cfg takes place in the context_processor.
        // In case a component provides cfg as default JS parameters, overriding such cfg
        // is not possible from the outside.
        // Some cfg of the ResourcesGrid component is set as default JS parameters, so we 
        // have to set that config here to make it overridable via override_local_config.
        
        const resourceGridPluginMenuItems = [
            {
                labelId: 'gnhome.addResource',
                disableIf: "{(state('settings') && state('settings').isMobile) || !(state('user') && state('user').perms && state('user').perms.includes('add_resource')) ? true : false}",
                type: 'dropdown',
                variant: 'primary',
                responsive: true,
                items: [
                    {
                        labelId: 'gnhome.uploadDataset',
                        value: 'layer',
                        type: 'link',
                        href: '/catalogue/#/upload/dataset'
                    },
                    {
                        labelId: 'gnhome.uploadDocument',
                        value: 'document',
                        type: 'link',
                        href: '/catalogue/#/upload/document'
                    },
                    {
                        labelId: 'gnhome.createDataset',
                        value: 'layer',
                        type: 'link',
                        href: '/createlayer/',
                        disableIf: "{(state('settings') && state('settings').createLayer) ? false : true}"
                    },
                    {
                        labelId: 'gnhome.createMap',
                        value: 'map',
                        type: 'link',
                        href: '/catalogue/#/map/new'
                    },
                    {
                        labelId: 'gnhome.createGeostory',
                        value: 'geostory',
                        type: 'link',
                        href: '/catalogue/#/geostory/new'
                    },
                    {
                        labelId: 'gnhome.createDashboard',
                        value: 'dashboard',
                        type: 'link',
                        href: '/catalogue/#/dashboard/new'
                    },
                    {
                        labelId: 'gnhome.remoteServices',
                        value: 'remote',
                        type: 'link',
                        href: '/services/?limit=5'
                    }
                ]
            },
            {
                type: 'divider'
            }
        ]

        const resourcesGridPluginFiltersFormItems = [
            {
                type: 'group',
                labelId: 'gnhome.customFiltersTitle',
                items: [
                    {
                        id: 'my-resources',
                        labelId: 'gnhome.myResources',
                        type: 'filter',
                        disableIf: '{!state("user")}'
                    },
                    {
                        id: 'favorite',
                        labelId: 'gnhome.favorites',
                        type: 'filter',
                        disableIf: '{!state("user")}'
                    },
                    {
                        id: 'featured',
                        labelId: 'gnhome.featuredList',
                        type: 'filter'
                    },
                    {
                        id: 'unpublished',
                        labelId: 'gnhome.unpublished',
                        type: 'filter',
                        disableIf: '{!state("user")}'
                    },
                    {
                        id: 'pending-approval',
                        labelId: 'gnhome.pendingApproval',
                        type: 'filter',
                        disableIf: '{!state("user")}'
                    },
                    {
                        id: 'dataset',
                        labelId: 'gnhome.datasets',
                        type: 'filter',
                        items: [
                            {
                                id: 'store-vector',
                                labelId: 'gnhome.vector',
                                type: 'filter'
                            },
                            {
                                id: 'store-raster',
                                labelId: 'gnhome.raster',
                                type: 'filter'
                            },
                            {
                                id: 'store-remote',
                                labelId: 'gnhome.remote',
                                type: 'filter'
                            },
                            {
                                id: 'store-time-series',
                                labelId: 'gnhome.timeSeries',
                                type: 'filter'
                            }
                        ]
                    },
                    {
                        id: 'document',
                        labelId: 'gnhome.documents',
                        type: 'filter'
                    },
                    {
                        id: 'map',
                        labelId: 'gnhome.maps',
                        type: 'filter'
                    },
                    {
                        id: 'geostory',
                        labelId: 'gnhome.geostories',
                        type: 'filter'
                    },
                    {
                        id: 'dashboard',
                        labelId: 'gnhome.dashboards',
                        type: 'filter'
                    }
                ]
            },
            {
                type: 'divider',
                disableIf: '{!state("user")}'
            },
            {
                labelId: 'gnhome.categories',
                placeholderId: 'gnhome.categoriesPlaceholder',
                type: 'select',
                suggestionsRequestKey: 'categories'
            },
            {
                labelId: 'gnhome.keywords',
                placeholderId: 'gnhome.keywordsPlaceholder',
                type: 'select',
                suggestionsRequestKey: 'keywords'
            },
            {
                labelId: 'gnhome.regions',
                placeholderId: 'gnhome.regionsPlaceholder',
                type: 'select',
                suggestionsRequestKey: 'regions'
            },
            {
                labelId: 'gnhome.owners',
                placeholderId: 'gnhome.ownersPlaceholder',
                type: 'select',
                suggestionsRequestKey: 'owners'
            }
        ];

        const { overrideLocalConfig } = window.__GEONODE_CONFIG__;
        window.__GEONODE_CONFIG__.overrideLocalConfig = function(localConfig, _) {
            if (overrideLocalConfig) {
                overrideLocalConfig(localConfig, _)
            }

            // #######################################
            // UI integration of litter assessment app

            Object.keys(localConfig.plugins).forEach(pageName => {
                if (["dataset_viewer"].includes(pageName)) {
                    localConfig.plugins[pageName].forEach(plugin => {
                        if (["ActionNavbar"].includes(plugin.name)) {
                            plugin.cfg.leftMenuItems.push({
                                type: "plugin",
                                name: "LitterAssessment",
                                disableIf: "{context.get(state('gnResourceData'), 'subtype') !== 'raster'}"
                            });
                        }
                    });
                }
            });
    
            // IMPORTANT!!! REMOVE AFTER DEVELOPMENT
            // temporary changes to develop extension
            // use absolute extensions folder path to correctly get http://localhost:8082 endpoint
            localConfig.extensionsFolder = '';
            // ensure that the http://localhost:8082 endpoint will not use proxy but direct requests
            localConfig.proxyUrl.useCORS.push('http://localhost:8082');


            // ###########################################
            // UI integration of external applications app

            Object.keys(localConfig.plugins).forEach(pageName => {
                if (["catalogue"].includes(pageName)) {
                    localConfig.plugins[pageName].forEach(plugin => {
                        if (["ResourcesGrid"].includes(plugin.name)) {

                            const filtersFormItems = resourcesGridPluginFiltersFormItems
                            filtersFormItems[0].items.push({
                                id: "externalapplication",
                                labelId: "externalapplications.filter",
                                type: "filter"
                            });
                            localConfig.geoNodeCustomFilters = Object.assign(localConfig.geoNodeCustomFilters, {
                                "externalapplication": {
                                    "filter{resource_type.in}": "externalapplication"
                                }
                            });

                            const menuItems = resourceGridPluginMenuItems
                            menuItems[0].items.push({
                                labelId: "externalapplications.register",
                                value: "externalapplication",
                                type: "link",
                                href: "/externalapplications/create",
                                authenticated: true,
                                perms: [
                                    {
                                        "type": "user",
                                        "value": "add_resource"
                                    }
                                ]
                            });

                            plugin.cfg.menuItems = menuItems;
                            plugin.cfg.filtersFormItems = filtersFormItems
                        }
                    });
                }
            });

            return localConfig;
        };
    })();
</script>
{% endblock %}